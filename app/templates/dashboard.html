{% extends "base.html" %}

{% block title %}Dashboard - EngageMeter{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
    <div>
      <h1 class="text-3xl font-bold text-base-content mb-2">Engagement Dashboard</h1>
      <p class="text-base-content/70">Track your social media performance and engagement metrics</p>
    </div>
    <div class="flex flex-wrap gap-2 mt-4 lg:mt-0">
      <a href="/" class="btn btn-outline btn-primary">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        Home
      </a>
      <a href="/upload" class="btn btn-primary">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        Upload CSV
      </a>
    </div>
  </div>
</div>

<!-- Statistics Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div class="stat bg-base-100 shadow-lg rounded-box border border-base-300">
    <div class="stat-figure text-primary">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
      </svg>
    </div>
    <div class="stat-title text-base-content/70">Total Score</div>
    <div class="stat-value text-primary">{{ total_score or 0 }}</div>
    <div class="stat-desc text-base-content/60">Sum of all engagement scores</div>
  </div>
  
  <div class="stat bg-base-100 shadow-lg rounded-box border border-base-300">
    <div class="stat-figure text-secondary">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
      </svg>
    </div>
    <div class="stat-title text-base-content/70">Total Tweets</div>
    <div class="stat-value text-secondary">{{ stats.total_tweets or 0 }}</div>
    <div class="stat-desc text-base-content/60">Number of tweets analyzed</div>
  </div>
  
  <div class="stat bg-base-100 shadow-lg rounded-box border border-base-300">
    <div class="stat-figure text-accent">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
      </svg>
    </div>
    <div class="stat-title text-base-content/70">Average Score</div>
    <div class="stat-value text-accent">{{ stats.average_score or 0 }}</div>
    <div class="stat-desc text-base-content/60">Total Score √∑ Total Tweets</div>
  </div>
  
  <div class="stat bg-base-100 shadow-lg rounded-box border border-base-300">
    <div class="stat-figure text-warning">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
      </svg>
    </div>
    <div class="stat-title text-base-content/70">Top Score</div>
    <div class="stat-value text-warning">{{ stats.top_score or 0 }}</div>
    <div class="stat-desc text-base-content/60">Highest single tweet score</div>
  </div>
</div>






      <div class="card bg-gradient-to-r from-primary/5 to-secondary/5 border border-primary/20">
        <div class="card-body p-4">
          <div class="flex justify-between items-start mb-3">
            <h3 class="card-title text-lg">
              {{ goal.goal_type.replace('_', ' ').title() }}
            </h3>
            <div class="badge badge-outline badge-primary">
              Due: {{ goal.end_date.strftime('%b %d, %Y') }}
            </div>
          </div>
          
          <!-- Progress Bar -->
          {% set progress_percentage = (goal.current_value / goal.target_value * 100) | round(1) %}
          <div class="mb-3">
            <div class="flex justify-between text-sm text-base-content/70 mb-2">
              <span>{{ goal.current_value | int }} / {{ goal.target_value | int }} {{ goal.unit }}</span>
              <span class="font-semibold">{{ progress_percentage }}%</span>
            </div>
            <progress class="progress progress-primary w-full" value="{{ progress_percentage }}" max="100"></progress>
          </div>
          
          <!-- Days Remaining -->
          {% set days_remaining = ((goal.end_date - now).days) | int %}
          <div class="flex items-center gap-2">
            {% if days_remaining > 0 %}
              <div class="badge badge-info gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                {{ days_remaining }} days remaining
              </div>
            {% elif days_remaining == 0 %}
              <div class="badge badge-warning gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                Due today!
              </div>
            {% else %}
              <div class="badge badge-error gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ days_remaining | abs }} days overdue
              </div>
            {% endif %}
          </div>
        </div>




<!-- Mathematical Consistency Check -->
{% if stats.total_tweets > 0 %}
<div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
  <div class="card-body">
    <h3 class="card-title text-xl mb-4">üîç Data Consistency Check</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">Total Score</div>
        <div class="stat-value text-lg">{{ total_score or 0 }}</div>
        <div class="stat-title">Total Tweets</div>
        <div class="stat-value text-lg">{{ stats.total_tweets or 0 }}</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">Calculated Average</div>
        <div class="stat-value text-lg">{{ total_score / stats.total_tweets if stats.total_tweets > 0 else 0 | round(2) }}</div>
        <div class="stat-title">Displayed Average</div>
        <div class="stat-value text-lg">{{ stats.average_score or 0 }}</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title">Consistency</div>
        <div class="stat-value text-lg">
          {% if (total_score / stats.total_tweets if stats.total_tweets > 0 else 0) | round(2) == stats.average_score %}
            <div class="badge badge-success gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Match
            </div>
          {% else %}
            <div class="badge badge-warning gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
              Mismatch
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Engagement Breakdown -->
<div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
  <div class="card-body">
    <h3 class="card-title text-2xl mb-4">Engagement Breakdown</h3>
    <p class="text-base-content/70 mb-6">Raw engagement counts from all your uploaded tweets (not weighted by point values)</p>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="stat bg-error/5 border border-error/20 rounded-box">
        <div class="stat-figure text-error">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
        </div>
        <div class="stat-title text-error">Likes</div>
        <div class="stat-value text-error text-2xl">{{ stats.engagement_breakdown.likes or 0 }}</div>
        <div class="stat-desc text-error/70">Total likes received</div>
      </div>
      
      <div class="stat bg-info/5 border border-info/20 rounded-box">
        <div class="stat-figure text-info">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </div>
        <div class="stat-title text-info">Retweets</div>
        <div class="stat-value text-info text-2xl">{{ stats.engagement_breakdown.retweets or 0 }}</div>
        <div class="stat-desc text-info/70">Total retweets received</div>
      </div>
      
      <div class="stat bg-success/5 border border-success/20 rounded-box">
        <div class="stat-figure text-success">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
        </div>
        <div class="stat-title text-success">Replies</div>
        <div class="stat-value text-success text-2xl">{{ stats.engagement_breakdown.replies or 0 }}</div>
        <div class="stat-desc text-success/70">Total replies received</div>
      </div>
      
      <div class="stat bg-warning/5 border border-warning/20 rounded-box">
        <div class="stat-figure text-warning">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div class="stat-title text-warning">Mentions</div>
        <div class="stat-value text-warning text-2xl">{{ stats.engagement_breakdown.mentions or 0 }}</div>
        <div class="stat-desc text-warning/70">Total mentions received</div>
      </div>
    </div>
  </div>
</div>

<!-- Scoring Explanation -->
{% if current_user.point_values %}
<div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
  <div class="card-body">
    <h3 class="card-title text-xl mb-4">üìä How Your Scoring Works</h3>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card bg-primary/5 border border-primary/20">
        <div class="card-body">
          <h4 class="card-title text-lg text-primary">Your Point Values</h4>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-xl">‚ù§Ô∏è</span>
                <span>Like</span>
              </span>
              <span class="badge badge-primary">{{ current_user.point_values.like }} point{{ 's' if current_user.point_values.like != 1 else '' }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-xl">üîÑ</span>
                <span>Retweet</span>
              </span>
              <span class="badge badge-primary">{{ current_user.point_values.retweet }} point{{ 's' if current_user.point_values.retweet != 1 else '' }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-xl">üí¨</span>
                <span>Reply</span>
              </span>
              <span class="badge badge-primary">{{ current_user.point_values.reply }} point{{ 's' if current_user.point_values.reply != 1 else '' }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="flex items-center gap-2">
                <span class="text-xl">üì¢</span>
                <span>Mention</span>
              </span>
              <span class="badge badge-primary">{{ current_user.point_values.mention }} point{{ 's' if current_user.point_values.mention != 1 else '' }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card bg-secondary/5 border border-secondary/20">
        <div class="card-body">
          <h4 class="card-title text-lg text-secondary">Score Calculation</h4>
          <p class="text-sm text-base-content/70 mb-3">Each tweet's score is calculated using this formula:</p>
          <div class="bg-base-200 p-3 rounded-box">
            <code class="text-sm">
              Score = (Likes √ó {{ current_user.point_values.like }}) + (Retweets √ó {{ current_user.point_values.retweet }}) + (Replies √ó {{ current_user.point_values.reply }}) + (Mentions √ó {{ current_user.point_values.mention }})
            </code>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Top Performers -->
{% if top_engagements %}
<div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
  <div class="card-body">
    <h3 class="card-title text-2xl mb-4">üèÜ Top Performing Tweets</h3>
    <div class="space-y-4">
      {% for engagement in top_engagements[:3] %}
      <div class="card bg-warning/5 border border-warning/20">
        <div class="card-body p-4">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-base-content mb-2">
                {{ engagement.tweet_text or "Tweet " + engagement.tweet_id[:10] + "..." }}
              </h4>
              <div class="flex flex-wrap gap-2 text-sm text-base-content/70">
                <span class="badge badge-outline badge-warning">Score: {{ engagement.engagement_score }}</span>
                <span class="badge badge-outline">‚ù§Ô∏è {{ engagement.like_count }}</span>
                <span class="badge badge-outline">üîÑ {{ engagement.retweet_count }}</span>
                <span class="badge badge-outline">üí¨ {{ engagement.reply_count }}</span>
                <span class="badge badge-outline">üì¢ {{ engagement.mention_count }}</span>
              </div>
            </div>
            <div class="ml-4">
              <div class="badge badge-warning badge-lg">#{{ loop.index }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Filters and Sorting -->
<div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
  <div class="card-body">
    <h3 class="card-title text-2xl mb-4">üîç Filters & Sorting</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <!-- Sort By -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Sort By</span>
        </label>
        <select 
          id="sort-by" 
          class="select select-bordered w-full"
          hx-get="/dashboard/api/engagements"
          hx-target="#engagements-table"
          hx-trigger="change"
          hx-include="[name='order'],[name='min_score'],[name='max_score'],[name='limit']"
        >
          <option value="score" {% if sort_by == "score" %}selected{% endif %}>Engagement Score</option>
          <option value="date" {% if sort_by == "date" %}selected{% endif %}>Date</option>
          <option value="engagement" {% if sort_by == "engagement" %}selected{% endif %}>Total Engagement</option>
          <option value="likes" {% if sort_by == "likes" %}selected{% endif %}>Likes</option>
          <option value="retweets" {% if sort_by == "retweets" %}selected{% endif %}>Retweets</option>
          <option value="replies" {% if sort_by == "replies" %}selected{% endif %}>Replies</option>
        </select>
      </div>

      <!-- Order -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Order</span>
        </label>
        <select 
          id="order" 
          name="order"
          class="select select-bordered w-full"
          hx-get="/dashboard/api/engagements"
          hx-target="#engagements-table"
          hx-trigger="change"
          hx-include="[name='sort_by'],[name='min_score'],[name='max_score'],[name='limit']"
        >
          <option value="desc" {% if order == "desc" %}selected{% endif %}>Descending</option>
          <option value="asc" {% if order == "asc" %}selected{% endif %}>Ascending</option>
        </select>
      </div>

      <!-- Min Score -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Min Score</span>
        </label>
        <input 
          type="number" 
          id="min-score" 
          name="min_score"
          value="{{ min_score or '' }}"
          placeholder="0"
          class="input input-bordered w-full"
          hx-get="/dashboard/api/engagements"
          hx-target="#engagements-table"
          hx-trigger="keyup changed delay:500ms"
          hx-include="[name='sort_by'],[name='order'],[name='max_score'],[name='limit']"
        >
      </div>

      <!-- Max Score -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Max Score</span>
        </label>
        <input 
          type="number" 
          id="max-score" 
          name="max_score"
          value="{{ max_score or '' }}"
          placeholder="1000"
          class="input input-bordered w-full"
          hx-get="/dashboard/api/engagements"
          hx-target="#engagements-table"
          hx-trigger="keyup changed delay:500ms"
          hx-include="[name='sort_by'],[name='order'],[name='min_score'],[name='limit']"
        >
      </div>
    </div>

    <!-- Results Limit -->
    <div class="form-control w-full max-w-xs">
      <label class="label">
        <span class="label-text font-medium">Results Limit</span>
      </label>
      <select 
        id="limit" 
        name="limit"
        class="select select-bordered w-full"
        hx-get="/dashboard/api/engagements"
        hx-target="#engagements-table"
        hx-trigger="change"
        hx-include="[name='sort_by'],[name='order'],[name='min_score'],[name='max_score']"
      >
        <option value="25" {% if limit == 25 %}selected{% endif %}>25 results</option>
        <option value="50" {% if limit == 50 %}selected{% endif %}>50 results</option>
        <option value="100" {% if limit == 100 %}selected{% endif %}>100 results</option>
      </select>
    </div>
  </div>
</div>

<!-- Engagements Table -->
<div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
  <div class="card-body">
    <h3 class="card-title text-2xl mb-4">üìä Engagement Data</h3>
    <div id="engagements-table">
      {% include "partials/engagements_table.html" %}
    </div>
  </div>
</div>

<!-- Refresh Button -->
<div class="text-center">
  <button
    class="btn btn-success btn-lg"
    hx-get="/dashboard/api/engagements"
    hx-target="#engagements-table"
    hx-include="[name='sort_by'],[name='order'],[name='min_score'],[name='max_score'],[name='limit']"
  >
    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
    Refresh Data
  </button>
</div>

<script>
// HTMX event handlers for better UX
document.addEventListener('htmx:beforeRequest', function(evt) {
  // Show loading state
  if (evt.target.id === 'engagements-table') {
    evt.target.innerHTML = `
      <div class="text-center py-12">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="mt-4 text-base-content/70">Loading engagement data...</p>
      </div>
    `;
  }
});

document.addEventListener('htmx:afterRequest', function(evt) {
  // Handle errors gracefully
  if (evt.detail.xhr.status !== 200) {
    evt.target.innerHTML = `
      <div class="text-center py-12">
        <div class="w-16 h-16 bg-error/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-base-content mb-2">Error Loading Data</h3>
        <p class="text-base-content/70 mb-4">There was an issue loading your engagement data.</p>
        <button class="btn btn-error btn-outline" onclick="location.reload()">Try Again</button>
      </div>
    `;
  }
});
</script>
{% endblock %}
