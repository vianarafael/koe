{% extends "base.html" %}

{% block title %}Upload CSV - EngageMeter{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-base-content mb-2">üì§ Upload X Analytics CSV</h1>
    <p class="text-base-content/70">Upload your X Analytics CSV export to start tracking engagement metrics</p>
  </div>

  <!-- Upload Form Card -->
  <div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-4">Upload & Process CSV</h2>
      
      <div class="mb-6">
        <p class="text-base-content/70">
          The system will automatically detect column names and parse your data. 
          Make sure your CSV contains engagement metrics like likes, retweets, replies, and mentions.
        </p>
      </div>

      <!-- Upload Form -->
      <form
        hx-post="/upload/csv"
        hx-encoding="multipart/form-data"
        hx-target="#upload-result"
        hx-swap="innerHTML"
        class="space-y-6"
      >
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Select CSV File</span>
          </label>
          <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
            <input
              type="file"
              id="file"
              name="file"
              accept=".csv"
              required
              class="file-input file-input-bordered file-input-primary w-full"
            />
            <button
              type="submit"
              class="btn btn-primary btn-lg"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              Upload & Process
            </button>
          </div>
          <label class="label">
            <span class="label-text-alt text-base-content/60">Only CSV files are supported. Maximum file size: 10MB</span>
          </label>
        </div>
      </form>

      <!-- Upload Result -->
      <div id="upload-result"></div>
    </div>
  </div>

  <!-- Uploaded Files List -->
  {% if csv_uploads %}
  <div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
    <div class="card-body">
      <h3 class="card-title text-xl mb-4">üìÅ Your Uploaded Files</h3>
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Uploaded</th>
              <th>Size</th>
              <th>Records</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for upload in csv_uploads %}
            <tr>
              <td class="font-mono text-sm">{{ upload.filename }}</td>
              <td>{{ upload.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ (upload.file_size / 1024) | round(1) }} KB</td>
              <td>{{ upload.records_stored }}/{{ upload.records_processed }}</td>
              <td>
                {% if upload.parse_errors %}
                  <span class="badge badge-warning">Warnings</span>
                {% else %}
                  <span class="badge badge-success">Success</span>
                {% endif %}
              </td>
              <td>
                <a href="/upload/download/{{ upload.id }}" class="btn btn-sm btn-outline">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Download
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Sample CSV Download Card -->
  <div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
    <div class="card-body">
      <h3 class="card-title text-xl mb-4">üìã Need a Sample CSV?</h3>
      <p class="text-base-content/70 mb-6">
        Download a sample CSV file to see the expected format and column names. 
        This will help you understand how to structure your data for optimal processing.
      </p>
      <a
        href="/upload/sample"
        class="btn btn-outline btn-primary"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Download Sample CSV
      </a>
    </div>
  </div>

  <!-- CSV Format Guide Card -->
  <div class="card bg-base-100 shadow-lg border border-base-300 mb-8">
    <div class="card-body">
      <h3 class="card-title text-xl mb-4">üìñ CSV Format Guide</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div class="card bg-primary/5 border border-primary/20">
            <div class="card-body p-4">
              <h4 class="font-semibold text-primary">Required Columns</h4>
              <div class="space-y-2 text-sm text-base-content/70">
                <div class="flex items-center gap-2">
                  <span class="badge badge-primary badge-sm">Required</span>
                  <span>tweet_id - Unique identifier for each tweet</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-primary badge-sm">Required</span>
                  <span>tweet_text - The content of your tweet</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-primary badge-sm">Required</span>
                  <span>posted_date - When the tweet was published</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-secondary/5 border border-secondary/20">
            <div class="card-body p-4">
              <h4 class="font-semibold text-secondary">Engagement Columns</h4>
              <div class="space-y-2 text-sm text-base-content/70">
                <div class="flex items-center gap-2">
                  <span class="badge badge-secondary badge-sm">Optional</span>
                  <span>like_count - Number of likes received</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-secondary badge-sm">Optional</span>
                  <span>retweet_count - Number of retweets</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-secondary badge-sm">Optional</span>
                  <span>reply_count - Number of replies</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-secondary badge-sm">Optional</span>
                  <span>mention_count - Number of mentions</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="space-y-4">
          <div class="card bg-accent/5 border border-accent/20">
            <div class="card-body p-4">
              <h4 class="font-semibold text-accent">File Requirements</h4>
              <div class="space-y-2 text-sm text-base-content/70">
                <div class="flex items-center gap-2">
                  <span class="badge badge-accent badge-sm">Format</span>
                  <span>CSV (Comma Separated Values)</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-accent badge-sm">Encoding</span>
                  <span>UTF-8 recommended</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-accent badge-sm">Size</span>
                  <span>Maximum 10MB</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="badge badge-accent badge-sm">Headers</span>
                  <span>First row should contain column names</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-info/5 border border-info/20">
            <div class="card-body p-4">
              <h4 class="font-semibold text-info">Processing Tips</h4>
              <div class="space-y-2 text-sm text-base-content/70">
                <div class="flex items-start gap-2">
                  <span class="badge badge-info badge-sm">Tip</span>
                  <span>Ensure dates are in YYYY-MM-DD format</span>
                </div>
                <div class="flex items-start gap-2">
                  <span class="badge badge-info badge-sm">Tip</span>
                  <span>Remove any special characters from column names</span>
                </div>
                <div class="flex items-start gap-2">
                  <span class="badge badge-info badge-sm">Tip</span>
                  <span>Use consistent number formatting for engagement counts</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- What Happens Next Card -->
  <div class="card bg-base-100 shadow-lg border border-base-300">
    <div class="card-body">
      <h3 class="card-title text-xl mb-4">üöÄ What Happens Next?</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center">
          <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-2xl">1Ô∏è‚É£</span>
          </div>
          <h4 class="font-semibold text-base-content mb-2">Upload & Parse</h4>
          <p class="text-sm text-base-content/70">Your CSV is uploaded and automatically parsed for engagement data</p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-2xl">2Ô∏è‚É£</span>
          </div>
          <h4 class="font-semibold text-base-content mb-2">Calculate Scores</h4>
          <p class="text-sm text-base-content/70">Engagement scores are calculated using your custom point values</p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 bg-accent/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-2xl">3Ô∏è‚É£</span>
          </div>
          <h4 class="font-semibold text-base-content mb-2">View Analytics</h4>
          <p class="text-sm text-base-content/70">Access your data on the dashboard with filters and insights</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Result Template -->
<template id="upload-result-template">
  <div class="alert alert-info">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <div>
      <h3 class="font-bold">Processing...</h3>
      <div class="text-sm">Please wait while we process your CSV file.</div>
    </div>
  </div>
</template>

<script>
// HTMX event handlers for better UX
document.addEventListener('htmx:beforeRequest', function(evt) {
  if (evt.target.closest('form')) {
    const resultDiv = document.getElementById('upload-result');
    const template = document.getElementById('upload-result-template');
    resultDiv.innerHTML = template.innerHTML;
  }
});

document.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.xhr.status !== 200) {
    const resultDiv = document.getElementById('upload-result');
    resultDiv.innerHTML = `
      <div class="alert alert-error">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        <div>
          <h3 class="font-bold">Upload Failed</h3>
          <div class="text-sm">There was an error processing your file. Please try again.</div>
        </div>
      </div>
    `;
  }
});
</script>
{% endblock %}
